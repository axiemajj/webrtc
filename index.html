<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Simple WebRTC Chat (No Server)</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    textarea { width: 100%; height: 100px; }
    pre { background: #f0f0f0; padding: 10px; overflow: auto; }
    #chatLog { height: 150px; }
  </style>
</head>
<body>
  <h2>üí¨ Simple WebRTC Chat (STUN only, no server)</h2>

  <button id="createOffer">1Ô∏è‚É£ Create Offer</button>
  <button id="createAnswer">2Ô∏è‚É£ Create Answer</button>
  <button id="setAnswer">3Ô∏è‚É£ Set Remote Answer</button>
  <br><br>

  <label>Offer / Answer Exchange</label>
  <textarea id="sdp" placeholder="Paste Offer or Answer here..."></textarea><br>

  <h3>Chat</h3>
  <div id="chatLog" style="border:1px solid #ccc; padding:10px; overflow:auto;"></div>
  <input id="msgInput" placeholder="Type a message..." />
  <button id="sendBtn">Send</button>

  <script>
    const pc = new RTCPeerConnection({
      iceServers: [{ urls: "stun:stun.l.google.com:19302" }] // ‚úÖ STUN only, no creds
    });

    let dataChannel;

    const createOfferBtn = document.getElementById("createOffer");
    const createAnswerBtn = document.getElementById("createAnswer");
    const setAnswerBtn = document.getElementById("setAnswer");
    const sdpTextarea = document.getElementById("sdp");
    const chatLog = document.getElementById("chatLog");
    const msgInput = document.getElementById("msgInput");
    const sendBtn = document.getElementById("sendBtn");

    function log(msg, type = "info") {
      const el = document.createElement("div");
      el.textContent = msg;
      if (type === "self") el.style.color = "blue";
      if (type === "peer") el.style.color = "green";
      chatLog.appendChild(el);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    // When a remote peer connects and creates a DataChannel
    pc.ondatachannel = (event) => {
      dataChannel = event.channel;
      dataChannel.onmessage = (e) => log("Peer: " + e.data, "peer");
      log("‚úÖ Data channel connected!");
    };

    // Collect ICE candidates
    const candidates = [];
    pc.onicecandidate = (event) => {
      if (event.candidate) {
        candidates.push(event.candidate);
      } else {
        // ICE gathering done
        sdpTextarea.value = JSON.stringify(pc.localDescription);
      }
    };

    // 1Ô∏è‚É£ Create an offer (for Peer A)
    createOfferBtn.onclick = async () => {
      dataChannel = pc.createDataChannel("chat");
      dataChannel.onmessage = (e) => log("Peer: " + e.data, "peer");
      dataChannel.onopen = () => log("‚úÖ Data channel open!");

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      log("üì§ Offer created! Copy the text below and send it to your peer.");
    };

    // 2Ô∏è‚É£ Create an answer (for Peer B)
    createAnswerBtn.onclick = async () => {
      const offer = JSON.parse(sdpTextarea.value);
      await pc.setRemoteDescription(offer);
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      log("üì§ Answer created! Copy the text below and send it back to your peer.");
    };

    // 3Ô∏è‚É£ Set remote answer (for Peer A)
    setAnswerBtn.onclick = async () => {
      const answer = JSON.parse(sdpTextarea.value);
      await pc.setRemoteDescription(answer);
      log("‚úÖ Remote answer set! You are now connected!");
    };

    // üì® Send a message over DataChannel
    sendBtn.onclick = () => {
      const msg = msgInput.value;
      if (dataChannel && dataChannel.readyState === "open") {
        dataChannel.send(msg);
        log("You: " + msg, "self");
        msgInput.value = "";
      } else {
        log("‚ö†Ô∏è Data channel not open yet!");
      }
    };
  </script>
</body>
</html>
